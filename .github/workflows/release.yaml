name: Create a superposition release

on: workflow_dispatch

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    tag-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            id-token: write
        if: github.ref == 'refs/heads/main'
        outputs:
            version: ${{ steps.git_tag.outputs.version }}
            updated_ref: ${{ steps.push_main.outputs.updated_ref }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.SUPERPOSITION_TOKEN }}

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  rust: 'true'
                  rust-wasm: 'true'
                  cargo-edit: 'true'
                  cocogitto: 'true'

            - name: Semver release
              shell: bash
              run: |
                  git config user.email "super_bot@juspay.in"
                  git config user.name "Superposition Bot"
                  cog bump --auto --skip-ci-override "[skip ci]"

            - name: Set latest tag
              id: git_tag
              shell: bash
              run: |
                  version=`git tag -l --sort=-creatordate | grep "^v" | head -n 1 | sed 's/^v//'`
                  echo "version=$version" >> $GITHUB_OUTPUT

            - name: Set the tag version to all crates
              run: |
                  cargo set-version --workspace ${{ steps.git_tag.outputs.version }}
                  cargo upgrade --package superposition_types@${{ steps.git_tag.outputs.version }}
                  cargo upgrade --package superposition_derives@${{ steps.git_tag.outputs.version }}
                  cargo upgrade --package superposition_macros@${{ steps.git_tag.outputs.version }}
                  cargo upgrade --package superposition_core@${{ steps.git_tag.outputs.version }}
                  cargo upgrade --package superposition_provider@${{ steps.git_tag.outputs.version }}
                  cargo upgrade --package superposition_sdk@${{ steps.git_tag.outputs.version }}
                  cargo upgrade --package service_utils@${{ steps.git_tag.outputs.version }}
                  sed -i "s/superposition: \"[0-9]\+\.[0-9]\+\.[0-9]\+\"/superposition: \"${{ steps.git_tag.outputs.version }}\"/" docs/src/constants/versions.js
                  git add .
                  git commit --amend --no-edit

            - name: Install yq
              run: |
                  # Get yq version from Makefile
                  YQ_VERSION=$(grep "^YQ_VERSION :=" makefiles/common.mk | sed 's/.*:= *//' | tr -d ' ')
                  mkdir -p ${{ github.workspace }}/bin
                  wget -qO ${{ github.workspace }}/bin/yq "https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64"
                  chmod +x ${{ github.workspace }}/bin/yq
                  echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

            - name: Update Helm chart appVersion
              run: |
                  yq eval ".appVersion = \"${{ steps.git_tag.outputs.version }}\"" -i helm/Chart.yaml
                  git add helm/Chart.yaml
                  git commit --amend --no-edit

            - name: Push code to main
              id: push_main
              shell: bash
              run: |
                  git pull --rebase origin main
                  git push origin main
                  git push origin --tags
                  echo "updated_ref=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

    docker-build:
        needs: tag-release
        permissions:
            contents: read
            packages: write
        if: github.ref == 'refs/heads/main'
        strategy:
            max-parallel: 5
            matrix:
                include:
                    - platform: linux/amd64
                      tag: linux-amd64
                      os: ubuntu-latest
                    - platform: linux/arm64
                      tag: linux-arm64
                      os: ubuntu-24.04-arm
        runs-on: ${{ matrix.os }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.SUPERPOSITION_TOKEN }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push production image
              uses: docker/build-push-action@v6
              with:
                  push: true
                  context: .
                  tags: ghcr.io/${{ github.repository }}:${{ needs.tag-release.outputs.version }}-${{ matrix.tag }}

    create-manifest:
        needs: [tag-release, docker-build]
        permissions:
            contents: read
            packages: write
        if: github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.SUPERPOSITION_TOKEN }}

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Create manifest for multi-arch image
              run: |
                  docker buildx imagetools create --tag ghcr.io/${{ github.repository }}:${{ needs.tag-release.outputs.version }} \
                      ghcr.io/${{ github.repository }}:${{ needs.tag-release.outputs.version }}-linux-amd64 \
                      ghcr.io/${{ github.repository }}:${{ needs.tag-release.outputs.version }}-linux-arm64

                  docker buildx imagetools create --tag ghcr.io/${{ github.repository }}:latest \
                      ghcr.io/${{ github.repository }}:${{ needs.tag-release.outputs.version }}-linux-amd64 \
                      ghcr.io/${{ github.repository }}:${{ needs.tag-release.outputs.version }}-linux-arm64

    docker-demo-build:
        needs: [tag-release, create-manifest]
        permissions:
            contents: read
            packages: write
        if: github.ref == 'refs/heads/main'
        strategy:
            max-parallel: 5
            matrix:
                include:
                    - platform: linux/amd64
                      tag: linux-amd64
                      os: ubuntu-latest
                    - platform: linux/arm64
                      tag: linux-arm64
                      os: ubuntu-24.04-arm
        runs-on: ${{ matrix.os }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.SUPERPOSITION_TOKEN }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push production image
              uses: docker/build-push-action@v6
              with:
                  push: true
                  context: .
                  file: example.Dockerfile
                  tags: ghcr.io/${{ github.repository }}-demo:${{ needs.tag-release.outputs.version }}-${{ matrix.tag }}

    create-demo-manifest:
        needs: [tag-release, docker-demo-build]
        permissions:
            contents: read
            packages: write
        if: github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.SUPERPOSITION_TOKEN }}

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Create manifest for multi-arch image
              run: |
                  docker buildx imagetools create --tag ghcr.io/${{ github.repository }}-demo:${{ needs.tag-release.outputs.version }} \
                      ghcr.io/${{ github.repository }}-demo:${{ needs.tag-release.outputs.version }}-linux-amd64 \
                      ghcr.io/${{ github.repository }}-demo:${{ needs.tag-release.outputs.version }}-linux-arm64

                  docker buildx imagetools create --tag ghcr.io/${{ github.repository }}-demo:latest \
                      ghcr.io/${{ github.repository }}-demo:${{ needs.tag-release.outputs.version }}-linux-amd64 \
                      ghcr.io/${{ github.repository }}-demo:${{ needs.tag-release.outputs.version }}-linux-arm64

    generate-rust-binary:
        needs: tag-release
        if: github.ref == 'refs/heads/main'
        strategy:
            max-parallel: 5
            matrix:
                platform:
                    - os: ubuntu-22.04
                      target: x86_64-unknown-linux-gnu
                      superposition_core_bin_name: libsuperposition_core.so
                      superposition_core_zip_name: superposition_core-x86_64-unknown-linux-gnu.zip
                    - os: macos-15-intel
                      target: x86_64-apple-darwin
                      superposition_core_bin_name: libsuperposition_core.dylib
                      superposition_core_zip_name: superposition_core-x86_64-apple-darwin.zip
                    - os: macos-latest
                      target: aarch64-apple-darwin
                      superposition_core_bin_name: libsuperposition_core.dylib
                      superposition_core_zip_name: superposition_core-aarch64-apple-darwin.zip
                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      superposition_core_bin_name: superposition_core.dll
                      superposition_core_zip_name: superposition_core-x86_64-pc-windows-msvc.zip

        runs-on: ${{ matrix.platform.os }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  rust: 'true'

            - name: Add Rust target
              run: rustup target add ${{ matrix.platform.target }}

            - name: Build and package for ${{ matrix.platform.os }}
              if: matrix.platform.os != 'windows-latest'
              run: |
                  cargo build --package superposition_core --release --target ${{ matrix.platform.target }}
                  mv target/${{ matrix.platform.target }}/release/${{ matrix.platform.superposition_core_bin_name }} ${{ matrix.platform.superposition_core_bin_name }}
                  mv target/include/superposition_core.h core.h
                  zip -r ${{ matrix.platform.superposition_core_zip_name }} ${{ matrix.platform.superposition_core_bin_name }} core.h

            - name: Build and package for ${{ matrix.platform.os }} on windows
              if: matrix.platform.os == 'windows-latest'
              run: |
                  cargo build --package superposition_core --release --target ${{ matrix.platform.target }}
                  Move-Item -Path "target\${{ matrix.platform.target }}\release\${{ matrix.platform.superposition_core_bin_name }}" -Destination "lib${{ matrix.platform.superposition_core_bin_name }}"
                  Move-Item -Path "target\include\superposition_core.h" -Destination "core.h"
                  Compress-Archive -Path "lib${{ matrix.platform.superposition_core_bin_name }}","core.h" -DestinationPath ${{ matrix.platform.superposition_core_zip_name }}

            - name: Upload superposition_core artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.platform.superposition_core_zip_name }}
                  path: ${{ matrix.platform.superposition_core_zip_name }}

    generate-java-packages:
        needs: [tag-release, generate-rust-binary]
        permissions:
            contents: read
            id-token: write
        if: github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        env:
            JRELEASER_GPG_SECRET_KEY: ${{ secrets.SONATYPE_MAVEN_SIGNING_KEY }}
            JRELEASER_GPG_PUBLIC_KEY: ${{ vars.SONATYPE_MAVEN_SIGNING_PUB_KEY }}
            JRELEASER_GPG_PASSPHRASE: ${{ secrets.SONATYPE_MAVEN_SIGNING_KEY_PASSWORD }}
            JRELEASER_MAVENCENTRAL_USERNAME: ${{ secrets.SONATYPE_MAVEN_USERNAME }}
            JRELEASER_MAVENCENTRAL_TOKEN: ${{ secrets.SONATYPE_MAVEN_PASSWORD }}
            VERSION: ${{ needs.tag-release.outputs.version }}
        defaults:
            run:
                working-directory: clients/java

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  java: 'true'

            - name: Download all rust binary artifacts
              uses: actions/download-artifact@v4
              with:
                  path: clients/java/rust-binaries
                  pattern: superposition_core-*
                  merge-multiple: true

            - name: List downloaded artifacts
              run: |
                  echo "Downloaded artifacts:"
                  ls -lar rust-binaries

            # Use Makefile target to setup binaries
            - name: Setup native binaries
              run: make java-setup-binaries

            - name: Publish and deploy
              run: |
                  make java-publish
                  make java-deploy

    generate-python-packages:
        needs: [tag-release, generate-rust-binary]
        if: github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        env:
            VERSION: ${{ needs.tag-release.outputs.version }}
            TWINE_USERNAME: __token__
            TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  python: 'true'
                  uv: 'true'

            - name: Install twine
              run: |
                  python -m pip install --upgrade pip
                  pip install twine

            - name: Download all rust binary artifacts
              uses: actions/download-artifact@v4
              with:
                  path: rust-binaries
                  pattern: superposition_core-*
                  merge-multiple: true

            - name: List downloaded artifacts
              run: |
                  echo "Downloaded artifacts:"
                  find rust-binaries -type f -name "*.zip" | sort

            # Use Makefile target to setup binaries and build
            - name: Setup native binaries
              run: make python-setup-binaries

            - name: Build and publish Python packages
              run: |
                  make python-collect-wheels
                  make python-publish

    generate-js-packages:
        needs: [tag-release, generate-rust-binary]
        if: github.ref == 'refs/heads/main'
        permissions:
            contents: read
            id-token: write
        runs-on: ubuntu-latest
        env:
            VERSION: ${{ needs.tag-release.outputs.version }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  node: 'true'

            - name: Download all rust binary artifacts
              uses: actions/download-artifact@v4
              with:
                  path: rust-binaries
                  pattern: superposition_core-*
                  merge-multiple: true

            - name: List downloaded artifacts
              run: |
                  echo "Downloaded artifacts:"
                  find rust-binaries -type f -name "*.zip" | sort

            # Use Makefile target to setup binaries and publish
            - name: Setup native binaries
              run: make js-setup-binaries

            - name: Publish JavaScript packages
              run: make js-publish
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    generate-rust-packages:
        needs: tag-release
        permissions:
            contents: read
            id-token: write
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        env:
            VERSION: ${{ needs.tag-release.outputs.version }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ needs.tag-release.outputs.updated_ref }}

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  rust: 'true'
                  rust-wasm: 'true'
                  cargo-edit: 'true'

            - name: Build and package superposition
              run: |
                  cargo login ${{ secrets.CRATES_IO_TOKEN }}
                  cargo publish --package superposition_derives
                  cargo publish --package superposition_sdk
                  cargo publish --package superposition_types
                  cargo publish --package superposition_core
                  cargo publish --package superposition_provider

    release:
        needs: [tag-release, generate-rust-binary]
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts_dir

            - name: List downloaded files
              run: ls -R artifacts_dir

            - uses: softprops/action-gh-release@v2
              name: Create GitHub Release
              with:
                  draft: true
                  files: |
                      artifacts_dir/superposition_core-x86_64-unknown-linux-gnu.zip/superposition_core-x86_64-unknown-linux-gnu.zip
                      artifacts_dir/superposition_core-x86_64-apple-darwin.zip/superposition_core-x86_64-apple-darwin.zip
                      artifacts_dir/superposition_core-aarch64-apple-darwin.zip/superposition_core-aarch64-apple-darwin.zip
                      artifacts_dir/superposition_core-x86_64-pc-windows-msvc.zip/superposition_core-x86_64-pc-windows-msvc.zip
