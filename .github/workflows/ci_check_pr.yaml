name: CI Checks on PRs

permissions:
    contents: read

on:
    pull_request:
        branches: [main]
    push:
        branches: [main]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

# Environment variables are now managed in makefiles/common.mk
# These are set here for jobs that run before make is available
env:
    # Cargo optimization for CI (also defined in makefiles/common.mk)
    CARGO_INCREMENTAL: 0
    CARGO_NET_RETRY: 10
    RUSTUP_MAX_RETRIES: 10
    RUST_BACKTRACE: short
    CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
    # AWS mock credentials for testing
    AWS_ACCESS_KEY_ID: test
    AWS_SECRET_ACCESS_KEY: test
    AWS_SESSION_TOKEN: test
    AWS_REGION: ap-south-1
    APP_ENV: "TEST"

jobs:
    formatting:
        name: Check formatting
        runs-on: anton1
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Restore cache (if present)
              uses: actions/cache/restore@v4
              id: cache-restore
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-cargo-test-

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  rust: 'true'
                  rust-wasm: 'true'
                  leptosfmt: 'true'
                  cocogitto: 'true'

            - name: Check formatting & linting
              shell: bash
              run: make check

            - name: Check conventional commit
              shell: bash
              run: |
                  if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                    git config --global user.name "${{ github.event.pull_request.user.login }}"
                    commit=$(git log --format=%B -n 1 ${{ github.event.pull_request.head.sha }})
                  else
                    git config --global user.name "${{ github.event.pusher.name }}"
                    commit=$(git log --format=%B -n 1 ${{ github.sha }})
                  fi
                  git config --global user.email "temp_email@juspay.in"
                  cog verify "$commit"

    test:
        name: Testing
        runs-on: anton1
        services:
            postgres:
                image: public.ecr.aws/docker/library/postgres:15-alpine3.21
                ports:
                    - 5432:5432
                env:
                    POSTGRES_PASSWORD: "docker"
                    POSTGRES_DB: "config"
                    restart: on-failure

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Restore cache (if present)
              uses: actions/cache/restore@v4
              id: cache-restore
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-cargo-test-

            - name: Install postgres libs
              run: |
                  sudo apt update
                  sudo apt-get -y install postgresql libpq-dev

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  rust: 'true'
                  rust-wasm: 'true'
                  node: 'true'
                  bun: 'true'
                  wasm-pack: 'true'

            - name: Run tests
              shell: bash
              run: make test CI=1

            - name: Save/update cache for future runs
              uses: actions/cache/save@v4
              id: cache-save
              if: github.ref == 'refs/heads/main'
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}

    java-build:
        name: Java build
        runs-on: anton1
        defaults:
            run:
                working-directory: clients/java

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Restore cache (if present)
              uses: actions/cache/restore@v4
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                  restore-keys: |
                      ${{ runner.os }}-gradle-

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  java: 'true'

            - name: Build Java client
              run: make assemble

            - name: Save/update cache for future runs
              uses: actions/cache/save@v4
              if: github.ref == 'refs/heads/main'
              with:
                  path: |
                      ~/.gradle/caches
                      ~/.gradle/wrapper
                  key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

            - name: Upload build artifacts
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: build-reports
                  path: |
                      build/reports/
                      build/test-results/
                  retention-days: 7

    provider-tests:
        name: Provider Tests
        runs-on: anton1
        strategy:
            matrix:
                provider:
                    - kotlin
                    - js
                    - py
                    - rust
        services:
            postgres:
                image: public.ecr.aws/docker/library/postgres:15-alpine3.21
                ports:
                    - 5432:5432
                env:
                    POSTGRES_PASSWORD: "docker"
                    POSTGRES_DB: "config"
                    restart: on-failure

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install postgres libs
              run: |
                  sudo apt update
                  sudo apt-get -y install postgresql libpq-dev

            - name: Make binary executable
              run: chmod +x scripts/setup_provider_binaries.sh

            - name: Restore cache (if present)
              uses: actions/cache/restore@v4
              id: cache-restore
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-cargo-test-

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  rust: 'true'
                  rust-wasm: 'true'
                  node: 'true'
                  bun: 'true'
                  java: ${{ matrix.provider == 'kotlin' && 'true' || 'false' }}
                  python: ${{ matrix.provider == 'py' && 'true' || 'false' }}
                  uv: ${{ matrix.provider == 'py' && 'true' || 'false' }}

            - name: Make gradlew executable (Kotlin)
              if: matrix.provider == 'kotlin'
              run: chmod +x clients/java/gradlew

            - name: Run Gradle assemble (Kotlin)
              if: matrix.provider == 'kotlin'
              run: make -C clients/java assemble

            - name: Run provider tests
              shell: bash
              run: |
                  cargo build --package superposition_core
                  export UV_PROJECT_ENVIRONMENT="${pythonLocation}"
                  echo "UV_PROJECT_ENVIRONMENT: $UV_PROJECT_ENVIRONMENT"
                  make test-${{ matrix.provider }}-provider

    binding-generation-check:
        name: Check generation of uniffi bindings
        runs-on: codebuild-superposition-${{ github.run_id }}-${{ github.run_attempt }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  rust: 'true'
                  rust-wasm: 'true'

            - name: Generate bindings
              run: make uniffi-bindings

            - name: Ensure no file changed
              run: git diff --exit-code

            - name: Show git diff on failure
              if: failure()
              run: |
                  echo "❌ The following files were modified:"
                  git diff --name-only
                  exit 1

    smithy-sdk-generation-check:
        name: Check generation of sdk from smithy models
        runs-on: codebuild-superposition-${{ github.run_id }}-${{ github.run_attempt }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # Use composite action with versions from makefiles/common.mk
            - name: Setup build tools
              uses: ./.github/actions/setup-tools
              with:
                  smithy: 'true'

            - name: Generate SDKs
              run: make smithy-updates

            - name: Ensure no unwanted file changes
              run: |
                  git diff --exit-code -- \
                    . \
                    ':(exclude)**/*.api.mdx' \
                    ':(exclude)clients/java/sdk/src/main/java/io/juspay/superposition/client/SuperpositionAsyncClientImpl.java' \
                    ':(exclude)clients/java/sdk/src/main/java/io/juspay/superposition/client/SuperpositionAsyncClient.java' \
                    ':(exclude)clients/java/sdk/src/main/java/io/juspay/superposition/client/SuperpositionClient.java' \
                    ':(exclude)clients/java/sdk/src/main/java/io/juspay/superposition/client/SuperpositionClientImpl.java'
                  git diff -I '^api:' --exit-code -- '**/*.api.mdx'

            - name: Show git diff on failure
              if: failure()
              run: |
                  echo "❌ The following files were modified:"
                  git diff --name-only
                  exit 1
