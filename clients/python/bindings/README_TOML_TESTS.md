# Python TOML Binding Tests

This directory contains a test script that demonstrates the usage of the TOML parsing functions exposed through the Python bindings generated by uniffi.

## Prerequisites

1. Build the superposition_core library:
   ```bash
   cargo build --release -p superposition_core
   ```

2. Generate Python bindings:
   ```bash
   make uniffi-bindings
   ```

3. Copy the compiled library to the bindings directory:
   ```bash
   cp target/release/libsuperposition_core.dylib \
      clients/python/bindings/superposition_bindings/libsuperposition_core-aarch64-apple-darwin.dylib
   ```

   Note: The filename will vary based on your architecture:
   - macOS ARM64: `libsuperposition_core-aarch64-apple-darwin.dylib`
   - macOS x86_64: `libsuperposition_core-x86_64-apple-darwin.dylib`
   - Linux: `libsuperposition_core-*.so`

## Running the Tests

```bash
cd clients/python/bindings
python3 test_toml_functions.py
```

## Test Coverage

The test script demonstrates four main capabilities:

### 1. Parse TOML Configuration (`ffi_parse_toml_config`)

Parses a TOML configuration string and returns structured data:

```python
from superposition_bindings.superposition_client import ffi_parse_toml_config

result = ffi_parse_toml_config(toml_content)

# Access parsed data
default_config = result.default_config  # dict[str, str]
contexts = json.loads(result.contexts_json)  # list of context objects
overrides = json.loads(result.overrides_json)  # dict of overrides
dimensions = json.loads(result.dimensions_json)  # dict of dimension info
```

### 2. Evaluate TOML Configuration (`ffi_eval_toml_config`)

Parses TOML and evaluates configuration based on input dimensions:

```python
from superposition_bindings.superposition_client import ffi_eval_toml_config

result = ffi_eval_toml_config(
    toml_content=toml_string,
    input_dimensions={
        "city": "Bangalore",
        "vehicle_type": "cab"
    },
    merge_strategy="merge"  # or "replace"
)

# result is a dict[str, str] with the evaluated configuration
print(result["per_km_rate"])  # e.g., "22.0"
```

### 3. Parse External TOML Files

Demonstrates reading and parsing TOML files from the filesystem:

```python
toml_content = Path("example.toml").read_text()
result = ffi_parse_toml_config(toml_content)
```

### 4. Error Handling

Shows proper error handling for invalid TOML or missing required sections:

```python
try:
    result = ffi_parse_toml_config(invalid_toml)
except Exception as e:
    print(f"Error: {e}")
```

## Merge Strategies

The `ffi_eval_toml_config` function accepts two merge strategies:

- `"merge"` (default): Merges override values with default configuration
- `"replace"`: Replaces entire configuration with override values

## Expected Output

When all tests pass, you should see:

```text
======================================================================
  TEST SUMMARY
======================================================================
  ✓ Parse TOML
  ✓ Eval TOML
  ✓ External File

  Total: 3/3 tests passed
======================================================================
```

## Test Scenarios

The evaluation test runs 5 scenarios demonstrating different dimension combinations:

1. **Bike ride** - Single dimension (vehicle_type=bike)
2. **Cab in Bangalore** - Two dimensions (city + vehicle_type)
3. **Delhi morning surge** - Three dimensions (city + vehicle_type + hour_of_day=6)
4. **Delhi evening surge** - Three dimensions (city + vehicle_type + hour_of_day=18)
5. **Auto ride** - Default configuration (vehicle_type=auto, no overrides)

Each scenario validates that the correct configuration is returned based on the context matching rules and priority system.

## TOML Structure

The test uses a ride-sharing pricing configuration with:

- **Default config**: Base rates (per_km_rate, surge_factor)
- **Dimensions**: city, vehicle_type, hour_of_day
- **Contexts**: Different pricing rules based on dimension combinations

See `test_toml_functions.py` for the complete TOML example or `examples/superposition_config_file_examples/example.toml` for a file-based example.
