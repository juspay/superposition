# Kotlin/Java TOML Binding Tests

This directory contains test cases that demonstrate the usage of the TOML parsing functions exposed through the Kotlin bindings generated by uniffi.

## Prerequisites

1. Build the superposition_core library:
   ```bash
   cargo build --release -p superposition_core
   ```

2. Generate Kotlin/Java bindings:
   ```bash
   make uniffi-bindings
   ```

3. Ensure the native library is in the correct location (handled by the build system)

## Running the Tests

```bash
cd clients/java/bindings
./gradlew test
```

To run with verbose output:
```bash
./gradlew test --info
```

To run a specific test:
```bash
./gradlew test --tests "uniffi.superposition_client.test.TomlFunctionsTest.testParseTomlConfig"
```

## Test Coverage

The test suite (`TomlFunctionsTest.kt`) demonstrates the following capabilities:

### 1. Parse TOML Configuration (`ffiParseTomlConfig`)

Parses a TOML configuration string and returns structured data:

```kotlin
import uniffi.superposition_client.ffiParseTomlConfig
import com.google.gson.Gson

val result = ffiParseTomlConfig(tomlContent)

// Access parsed data
val defaultConfig = result.defaultConfig  // Map<String, String>
val contexts = gson.fromJson(result.contextsJson, ...)  // Parse JSON string
val overrides = gson.fromJson(result.overridesJson, ...)  // Parse JSON string
val dimensions = gson.fromJson(result.dimensionsJson, ...)  // Parse JSON string
```

### 2. Evaluate TOML Configuration (`ffiEvalTomlConfig`)

Parses TOML and evaluates configuration based on input dimensions:

```kotlin
import uniffi.superposition_client.ffiEvalTomlConfig

val result = ffiEvalTomlConfig(
    tomlContent = tomlString,
    inputDimensions = mapOf(
        "city" to "Bangalore",
        "vehicle_type" to "cab"
    ),
    mergeStrategy = "merge"  // or "replace"
)

// result is a Map<String, String> with the evaluated configuration
println(result["per_km_rate"])  // e.g., "22.0"
```

## Test Cases

The test suite includes the following test cases:

### Parsing Tests
- **testParseTomlConfig**: Validates parsing of TOML into structured format
  - Checks default configuration keys
  - Validates contexts parsing
  - Verifies overrides and dimensions

### Evaluation Tests
- **testEvalTomlConfig_BikeRide**: Single dimension (vehicle_type=bike)
- **testEvalTomlConfig_CabInBangalore**: Two dimensions (city + vehicle_type)
- **testEvalTomlConfig_DelhiMorningSurge**: Three dimensions with hour_of_day=6
- **testEvalTomlConfig_DelhiEveningSurge**: Three dimensions with hour_of_day=18
- **testEvalTomlConfig_AutoRide**: Default configuration (no overrides)

### Error Handling Tests
- **testErrorHandling_InvalidToml**: Validates error handling for malformed TOML
- **testErrorHandling_MissingSection**: Validates error for missing required sections

### Strategy Tests
- **testMergeStrategy_Replace**: Tests the "replace" merge strategy

## Expected Output

When tests pass, you should see output like:

```
======================================================================
  TEST: Parse TOML Configuration
======================================================================

âœ“ Successfully parsed TOML configuration!

Default Configuration:
--------------------------------------------------
  per_km_rate: 20.0
  surge_factor: 0.0

Contexts:
--------------------------------------------------
  Context 1:
    Condition: {"city":"Bangalore","vehicle_type":"cab"}
    Override ID: N/A
    Priority: 10
...

BUILD SUCCESSFUL
```

## Merge Strategies

The `ffiEvalTomlConfig` function accepts two merge strategies:

- `"merge"` (default): Merges override values with default configuration
- `"replace"`: Replaces entire configuration with override values

## Using in Your Project

### Gradle Dependency

```kotlin
dependencies {
    implementation("io.juspay.superposition:superposition-bindings:VERSION")
    implementation("net.java.dev.jna:jna:5.13.0")

    // For JSON parsing
    implementation("com.google.code.gson:gson:2.10.1")
}
```

### Basic Usage Example

```kotlin
import uniffi.superposition_client.*
import com.google.gson.Gson

fun main() {
    val toml = """
        [default-config]
        rate = { "value" = 10.0, "schema" = { "type" = "number" } }

        [dimensions]
        region = { schema = { "type" = "string" } }

        [context."region=us"]
        rate = 15.0
    """.trimIndent()

    // Parse TOML
    val parsed = ffiParseTomlConfig(toml)
    println("Default config: ${parsed.defaultConfig}")

    // Evaluate with dimensions
    val config = ffiEvalTomlConfig(
        tomlContent = toml,
        inputDimensions = mapOf("region" to "us"),
        mergeStrategy = "merge"
    )
    println("Evaluated rate: ${config["rate"]}")  // "15.0"
}
```

## Exception Handling

The functions throw `OperationException` for errors:

```kotlin
try {
    val result = ffiParseTomlConfig(invalidToml)
} catch (e: OperationException) {
    when (e) {
        is OperationException.Unexpected -> {
            println("Error: ${e.message}")
        }
    }
}
```

## TOML Structure

The TOML configuration follows this structure:

```toml
[default-config]
key1 = { "value" = <value>, "schema" = <json-schema> }
key2 = { "value" = <value>, "schema" = <json-schema> }

[dimensions]
dim1 = { schema = <json-schema> }
dim2 = { schema = <json-schema> }

[context."dim1=value1"]
key1 = <override-value>

[context."dim1=value1; dim2=value2"]
key2 = <override-value>
```

See the test file for a complete ride-sharing pricing example.
